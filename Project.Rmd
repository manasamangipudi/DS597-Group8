---
title: "R Notebook"
output: html_notebook
---

```{r}

# Load required libraries
library(tidyverse)
library(skimr)
library(janitor)
library(naniar)
library(ggplot2)
library(corrplot)

```

```{r}

# Load the raw dataset from OWID
load_energy_data <- function(url = "https://raw.githubusercontent.com/owid/energy-data/master/owid-energy-data.csv") {
  read_csv(url)
}

impute_energy_data <- function(df) {
  df %>%
    group_by(country) %>%
    mutate(across(
      where(is.numeric),
      ~ coalesce(., mean(., na.rm = TRUE)) %>% replace_na(0)
    )) %>%
    ungroup()
}

filter_energy_data <- function(df) {
  df %>%
    filter(!str_starts(iso_code, "OWID"), !is.na(country), !is.na(year)) %>%
    filter(year >= 2000) %>%
    select(where(~ sum(is.na(.)) < 0.4 * nrow(df))) %>%
    filter(!is.na(population), !is.na(gdp))
}

select_energy_columns <- function(df) {
  df %>%
    select(
      country, iso_code, year, population, gdp,
      electricity_generation,
      renewables_electricity, fossil_electricity,
      solar_electricity, wind_electricity, hydro_electricity,
      renewables_share_elec, coal_share_elec, gas_share_elec, oil_share_elec
    ) 
}

add_normalized_metrics <- function(df) {
  df %>%
    mutate(
      electricity_per_capita = electricity_generation / population,
      renewables_per_capita = renewables_electricity / population,
      fossil_per_capita = fossil_electricity / population,
      electricity_per_gdp = electricity_generation / gdp,
      gdp_per_electricity = gdp / (electricity_generation + 1)
    )
}

add_log_transforms <- function(df) {
  df %>%
    mutate(
      log_gdp = log(gdp),
      log_population = log(population),
      log_electricity = log(electricity_generation+1)
    )
}

add_energy_ratios <- function(df) {
  df %>%
    mutate(
      fossil_to_renewable_ratio = fossil_electricity / (renewables_electricity + 1),
      fossil_share_elec = fossil_electricity / (electricity_generation + 1),
      solar_share = solar_electricity / (renewables_electricity + 1),
      wind_share = wind_electricity / (renewables_electricity + 1),
      hydro_share = hydro_electricity / (renewables_electricity + 1)
    )
}

add_classification_flags <- function(df) {
  df %>%
    mutate(
      high_renewable = if_else(renewables_share_elec > 50, 1, 0),
      transitioning = if_else(renewables_share_elec > fossil_share_elec, 1, 0)
    )
}

transform_energy_data <- function(df) {
  df %>%
    add_normalized_metrics() %>%
    add_log_transforms() %>%
    add_energy_ratios() %>%
    add_classification_flags()
}


na_percentage <- function(df) {
  sapply(df, function(col) round(mean(is.na(col)) * 100, 2))
}


```


```{r}

# STEP 1: Load raw dataset
energy_raw <- load_energy_data()
write_csv(energy_raw, "/Users/manasamangipudi/Desktop/Semester-3/DataWrangling/Project/data/raw/energy_raw.csv")

# STEP 2: Filter rows and columns
energy_clean <- filter_energy_data(energy_raw)

# STEP 3: Impute missing values (country-level means)
#energy_imputed <- impute_energy_data(energy_clean)

# STEP 4: Select meaningful columns (for analysis + merge)
energy_selected <- select_energy_columns(energy_clean)

# STEP 5: Transform data (all feature engineering)
energy_transformed <- transform_energy_data(energy_selected)

# STEP 6: Save final dataset
write_csv(energy_transformed, "/Users/manasamangipudi/Desktop/Semester-3/DataWrangling/Project/data/cleaned/energy_transformed.csv")

# Optional: View NA % per column (quality check)
print(na_percentage(energy_transformed))

```

```{r}

# Glimpse and summary
glimpse(energy_transformed)
skim(energy_transformed)
summary(energy_transformed)

```

```{r}
numeric_cols <- energy_transformed %>% select(where(is.numeric)) %>% drop_na()
corrplot(cor(numeric_cols), method = "color", type = "upper", tl.cex = 0.7)

```

```{r}

energy_transformed %>%
  select(electricity_per_capita, renewables_per_capita, fossil_per_capita, electricity_per_gdp, gdp_per_electricity) %>%
  pivot_longer(everything()) %>%
  ggplot(aes(value)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black") +
  facet_wrap(~name, scales = "free") +
  theme_minimal() +
  labs(title = "Distribution of Normalized Energy Metrics")

```

```{r}

drop_outliers_thresh <- function(df, max_outliers = 2) {
  numeric_cols <- df %>% select(where(is.numeric)) %>% colnames()
  
  outlier_matrix <- map_dfc(numeric_cols, function(col) {
    Q1 <- quantile(df[[col]], 0.25, na.rm = TRUE)
    Q3 <- quantile(df[[col]], 0.75, na.rm = TRUE)
    IQR <- Q3 - Q1
    lower <- Q1 - 1.5 * IQR
    upper <- Q3 + 1.5 * IQR
    tibble(!!col := df[[col]] < lower | df[[col]] > upper)
  })
  
  # Count number of outlier flags per row
  row_outlier_counts <- outlier_matrix %>% rowSums(na.rm = TRUE)
  
  # Keep rows with <= max_outliers
  df[row_outlier_counts <= max_outliers, ]
}

# Drop only if more than 2 outlier columns
energy_transformed_clean <- drop_outliers_thresh(energy_transformed, max_outliers = 9)

cat("Original:", nrow(energy_transformed), "â†’ After smarter outlier removal:", nrow(energy_transformed_clean), "\n")

```
```{r}

energy_transformed %>% filter(duplicated(.))
```


```{r}
 
energy_transformed <- read_csv("/Users/manasamangipudi/Desktop/Semester-3/DataWrangling/Project/data/cleaned/energy_transformed_new.csv")
co2_transformed <- read_csv("/Users/manasamangipudi/Desktop/Semester-3/DataWrangling/Project/data/cleaned/co2_transformed.csv")

# # Check for overlapping years
 intersect(energy_transformed$year, co2_transformed$year)
# 

co2_transformed <- co2_transformed %>%
  select(-iso_code, -population, -gdp, -log_gdp)
# 

energy_co2_merged <- left_join(
  energy_transformed,
  co2_transformed,
  by = c("country", "year")#,"iso_code","population","gdp")
)

write_csv(energy_co2_merged, "/Users/manasamangipudi/Desktop/Semester-3/DataWrangling/Project/data/energy_co2_data_merged.csv")

```

```{r}
drop_outliers_thresh <- function(df, max_outliers = 9) {
  numeric_cols <- df %>% select(where(is.numeric)) %>% colnames()
  outlier_matrix <- map_dfc(numeric_cols, function(col) {
    Q1 <- quantile(df[[col]], 0.25, na.rm = TRUE)
    Q3 <- quantile(df[[col]], 0.75, na.rm = TRUE)
    IQR <- Q3 - Q1
    lower <- Q1 - 2 * IQR
    upper <- Q3 + 2 * IQR
    tibble(!!col := df[[col]] < lower | df[[col]] > upper)
  })
  row_outlier_counts <- outlier_matrix %>% rowSums(na.rm = TRUE)
  df[row_outlier_counts <= max_outliers, ]
}

energy_co2_merged <- drop_outliers_thresh(energy_co2_merged, max_outliers = 20)

```


```{r}
ene

```


```{r}

energy_co2_merged

```